<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spaced Recall Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@600;700&family=M+PLUS+1p:wght@700;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#eef3ff; --surface:#ffffff; --ink:#0b1324; --muted:#5b6577; --line:#e7ebf5; --line2:#dfe6f7;
    --accent:#3b82f6; --accent-2:#22d3ee;
    --jp: 'M PLUS 1p','Noto Sans JP',system-ui,sans-serif;
    --lat: 'Bebas Neue','Rajdhani',system-ui,sans-serif;
    --shadow-strong: 0 10px 24px rgba(16,24,40,.20), 0 2px 6px rgba(16,24,40,.10);
  }
  *{box-sizing:border-box;font-family:var(--jp); letter-spacing:.1px}
  body{margin:0;color:var(--ink);background:linear-gradient(180deg,#fafdff,#eef3ff);}
  .bg-anim::before, .bg-anim::after{content:'';position:fixed;inset:-30vh -30vw auto auto;pointer-events:none;z-index:-2;width:80vw;height:80vh;filter:blur(60px);opacity:.7;
    background: radial-gradient(60% 60% at 50% 50%, rgba(34,211,238,.45), transparent 70%),
                radial-gradient(40% 40% at 20% 30%, rgba(59,130,246,.35), transparent 70%),
                radial-gradient(30% 30% at 80% 20%, rgba(125,211,252,.30), transparent 70%); animation: float1 16s ease-in-out infinite alternate;}
  .bg-anim::after{inset:auto auto -30vh -30vw; width:70vw;height:70vh; filter:blur(70px); opacity:.6;
    background: radial-gradient(60% 60% at 50% 50%, rgba(59,130,246,.35), transparent 70%),
                radial-gradient(40% 40% at 60% 40%, rgba(34,211,238,.30), transparent 70%),
                radial-gradient(30% 30% at 30% 70%, rgba(56,189,248,.25), transparent 70%); animation: float2 18s ease-in-out infinite alternate;}
  @keyframes float1{ from{transform:translate3d(-3%,2%,0)} to{transform:translate3d(3%,-2%,0)} }
  @keyframes float2{ from{transform:translate3d(2%,-3%,0)} to{transform:translate3d(-2%,3%,0)} }

  header{position:sticky;top:0;z-index:60;background:rgba(255,255,255,.72);
    backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
  .wrap{max-width:1180px;margin:0 auto;padding:14px 16px}

  /* Brand */
  .brand{display:flex;align-items:center;gap:10px}
  .brand-badge{width:34px;height:34px;border-radius:10px;
    background: radial-gradient(120% 120% at 30% 20%, #7dd3fc, transparent 40%),
                linear-gradient(145deg, #0ea5e9, #1d4ed8);
    box-shadow: inset 0 1px 2px rgba(255,255,255,.6),
                0 8px 20px rgba(29,78,216,.22), 0 1px 3px rgba(2,6,23,.25); position:relative}
  .brand-badge::after{content:''; position:absolute; inset:6px; border-radius:8px; background: linear-gradient(145deg, rgba(255,255,255,.22), rgba(255,255,255,.05));}
  .brand-text{margin:0;font-size:30px;letter-spacing:.6px;font-family:var(--lat),var(--jp); font-weight:900;
    color:#0b1324}
  @supports(-webkit-background-clip:text){
    .brand-text{ background: linear-gradient(90deg, #0ea5e9 0%, #2563eb 35%, #7dd3fc 100%);
      -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow: 0 10px 20px rgba(29,78,216,.08); }
  }

  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px}

  .btn{
    --base:#f0f3ff; position:relative;border:none;border-radius:18px;padding:12px 18px;cursor:pointer;
    color:#0f172a;background: linear-gradient(180deg, #ffffff 0%, var(--base) 100%);
    box-shadow: inset 0 2px 0 rgba(255,255,255,.9), inset 0 -2px 8px rgba(15,23,42,.10),
                0 8px 18px rgba(15,23,42,.12), 0 2px 6px rgba(15,23,42,.08);
    transition: transform .12s ease, box-shadow .12s ease; font-weight:800;}
  .btn::after{content:'';position:absolute;left:10%;right:10%;top:6%;height:45%;background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.25));border-radius:16px; filter: blur(.2px); pointer-events:none;}
  .btn:hover{ transform:translateY(-1px); box-shadow: inset 0 2px 0 rgba(255,255,255,.95), inset 0 -2px 8px rgba(15,23,42,.12),
              0 12px 24px rgba(15,23,42,.16), 0 4px 10px rgba(15,23,42,.12); }
  .btn:active{ transform:translateY(1px); }
  .btn.primary{ --base:#cfe9ff; color:#053260; background: linear-gradient(180deg, #e7f3ff 0%, #cfe9ff 60%, #c5e6ff 100%);
    border:1px solid rgba(59,130,246,.35); text-shadow:0 1px 0 rgba(255,255,255,.7);
    box-shadow: inset 0 2px 0 rgba(255,255,255,.9), inset 0 -6px 10px rgba(59,130,246,.25), 0 10px 24px rgba(59,130,246,.28), 0 2px 6px rgba(59,130,246,.18);}

  /* SOFT COLORED OUTCOME BUTTONS (restore) */
  .btn.reveal{ --base:#ecfdf5; background:linear-gradient(180deg,#ffffff,#ecfdf5); border:1px solid rgba(16,185,129,.26); }
  .btn.bad{ --base:#fff1f1; background:linear-gradient(180deg,#ffffff,#fff1f1); border:1px solid rgba(239,68,68,.26); }
  .btn.mid{ --base:#fffee3; background:linear-gradient(180deg,#ffffff,#fffee3); border:1px solid rgba(245,158,11,.26); }
  .btn.good{ --base:#eef6ff; background:linear-gradient(180deg,#ffffff,#eef6ff); border:1px solid rgba(59,130,246,.26); }

  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.9);box-shadow:var(--shadow-strong);font-size:14px;font-weight:800}

  main.wrap{padding:22px 16px}
  .card{background:rgba(255,255,255,.85);border:1px solid var(--line);border-radius:20px;box-shadow:var(--shadow-strong)}
  .inner{padding:20px}

  /* Title */
  .title{font-size:24px;margin:0 0 12px;letter-spacing:.2px;font-weight:900; position:relative; display:flex; align-items:center; gap:10px;
    padding:10px 12px; border:1px solid var(--line2); border-radius:12px; background:linear-gradient(180deg,#ffffff,#f6f9ff); box-shadow: inset 0 1px 0 rgba(255,255,255,.8)}
  .ttext{font-weight:900; color:#0b1324}
  @supports(-webkit-background-clip:text){
    .ttext{ -webkit-background-clip:text; background-clip:text; color:transparent; background: linear-gradient(90deg,#38bdf8,#3b82f6); }
    .ttext.g2{ background: linear-gradient(90deg,#22d3ee,#60a5fa) }
    .ttext.g3{ background: linear-gradient(90deg,#7dd3fc,#2563eb) }
    .ttext.g4{ background: linear-gradient(90deg,#93c5fd,#22d3ee) }
  }
  .title .vsep{width:1px;height:18px;background:var(--line2);border-radius:999px}
  .title-tag{font-family:var(--lat),var(--jp); font-weight:900; font-size:12px; letter-spacing:.6px; padding:6px 10px; border-radius:999px; border:1px solid var(--line);
    background:linear-gradient(180deg,#fff,#f1f6ff); box-shadow:var(--shadow-strong)}

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .hidden{display:none}

  input,textarea,select{width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);
    background:linear-gradient(180deg,#ffffff,#f7f9ff);outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.9);font-weight:800;}
  textarea{min-height:100px;white-space:pre}

  .prompt{font-size:48px;letter-spacing:.4px;margin:10px 0 8px;text-align:center;font-family:var(--jp);font-weight:900}
  .answer{font-size:26px;text-align:center;margin-top:4px;color:#334155;font-weight:800}
  .muted{color:var(--muted);font-size:14px;font-weight:700}

  .ring{width:62px;height:62px;border-radius:50%;background:conic-gradient(#3b82f6 var(--pct,0%), #e5e7eb 0);
    position:relative; box-shadow:0 0 24px rgba(59,130,246,.35)}
  .ring::after{content:'';position:absolute;inset:6px;background:#fff;border-radius:50%;box-shadow:inset 0 1px 0 rgba(0,0,0,.03)}
  .ring-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;color:#0b1324}

  table{width:100%;border-collapse:separate;border-spacing:0;font-size:16px}
  th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;vertical-align:top;font-weight:800}
  th:not(:last-child), td:not(:last-child){border-right:1px solid var(--line);}
  #tbl{table-layout:auto}
  #tbl td input{font-size:18px; padding:10px 12px; border-radius:12px;}
  #tbl td:nth-child(2) input{min-width:260px; font-weight:900;}
  #tbl td:nth-child(3) input{min-width:260px;}
  #tbl td:nth-child(4) input{min-width:140px;}
  #tbl td:nth-child(5) input{min-width:200px;}
  #tbl th:nth-child(5), #tbl td:nth-child(5){max-width:280px}
  #tbl td{white-space:nowrap}

  .fade{animation:fade .25s ease both}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

  /* Section blocks */
  .segblock{position:relative; overflow:hidden; padding:14px; border:1px solid var(--line); border-radius:16px; background:linear-gradient(180deg,#ffffff,#f7fbff); box-shadow: inset 0 1px 0 rgba(255,255,255,.8); margin:12px 0;}
  .segblock > *{position:relative; z-index:1}
  .divider{height:1px; background:linear-gradient(90deg, rgba(34,211,238,.22), rgba(59,130,246,.22)); border-radius:999px; margin:12px 0;}

  /* Animated backgrounds */
  .anim-liquid::before{content:''; position:absolute; inset:-30% -20%; pointer-events:none; z-index:0; filter:blur(48px); opacity:.22;
    background:
      radial-gradient(35% 35% at 20% 30%, rgba(59,130,246,.85), transparent 70%),
      radial-gradient(30% 30% at 80% 20%, rgba(34,211,238,.75), transparent 70%),
      radial-gradient(25% 25% at 60% 80%, rgba(125,211,252,.75), transparent 70%);
    animation: liquidMove 18s ease-in-out infinite alternate;}
  @keyframes liquidMove{ from{ transform:translate3d(-4%,3%,0) rotate(0deg);} to{ transform:translate3d(4%,-3%,0) rotate(8deg);} }

  .anim-bubbles::before{content:''; position:absolute; inset:-20% -10%; pointer-events:none; z-index:0; opacity:.16; filter:blur(.3px);
    background:
      radial-gradient(40px 40px at 20% 90%, rgba(255,255,255,.9), transparent 60%),
      radial-gradient(34px 34px at 65% 110%, rgba(125,211,252,.85), transparent 60%),
      radial-gradient(28px 28px at 85% 95%, rgba(59,130,246,.8), transparent 60%),
      radial-gradient(24px 24px at 35% 100%, rgba(34,211,238,.8), transparent 60%);
    animation: bubblesUp 22s linear infinite; }
  @keyframes bubblesUp{ from{ transform:translateY(0);} to{ transform:translateY(-18%);} }

  /* Pills & misc */
  .tvbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
  .pill{border-radius:999px;padding:8px 14px;background:rgba(255,255,255,.9);border:1px solid var(--line);cursor:pointer;box-shadow:var(--shadow-strong);font-weight:800}
  .pill.active{background:linear-gradient(180deg,#e7f3ff,#cfe9ff);border-color:#9cc5ff}

  /* Timer */
  .seg{display:inline-flex; border-radius:999px; border:1px solid var(--line); background:linear-gradient(180deg,#fff,#f3f7ff); box-shadow:var(--shadow-strong)}
  .seg-btn{padding:8px 14px; font-weight:900; border:none; background:transparent; cursor:pointer; border-radius:999px}
  .seg-btn.active{background:linear-gradient(180deg,#e7f3ff,#cfe9ff); border:1px solid #9cc5ff; box-shadow: inset 0 1px 0 rgba(255,255,255,.9)}
  .timer-toggle{margin-left:auto}
  .timer-panel{position:fixed; right:16px; top:84px; width:340px; max-width:92vw; z-index:2000;
    background:linear-gradient(180deg,#ffffff,#f1f5ff); border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow-strong); padding:12px;}
  .timer-head{display:flex; gap:8px; align-items:center; margin-bottom:8px}
  .time-big{font-family:var(--lat),var(--jp); font-size:44px; letter-spacing:.6px; text-align:center; margin:4px 0 8px; font-weight:900}
  .timer-row{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center}
  #fabTimer{position:fixed; right:16px; bottom:16px; z-index:2001; padding:14px 18px; border-radius:999px}

  @media (max-width:720px){
    .toolbar{gap:8px}
    .chip{padding:6px 10px}
    .time-big{font-size:38px}
    #tbl td:nth-child(2) input, #tbl td:nth-child(3) input{min-width:200px}
    #tbl td:nth-child(5) input{min-width:180px}
  }

  /* --- v7.6 overrides --- */
  .ttext{ color:#0b1324 !important; -webkit-background-clip:initial !important; background-clip:initial !important; }
  /* Stronger on-card animations */
  .anim-liquid::before{opacity:.38 !important; filter:blur(36px) !important;}
  .anim-bubbles::before{opacity:.28 !important;}

  /* --- v7.7 heading readability --- */
  .title{ background:linear-gradient(180deg,#ffffff,#f9fbff)!important; border-color:#e7ecf7!important; padding:12px 14px!important; }
  .title .ttext{ 
    font-size:22px!important; line-height:1.2!important; letter-spacing:.2px!important; 
    display:inline-flex; align-items:center; gap:10px;
  }
  .title .ttext::before{
    content:''; display:inline-block; width:6px; height:1.3em; border-radius:6px;
    background:linear-gradient(180deg,#60a5fa,#22d3ee); box-shadow:0 1px 3px rgba(34,197,235,.25);
  }
  @media (min-width:860px){ .title .ttext{ font-size:24px!important; } }

  /* --- v7.8 heading readability (final polish) --- */
  .title{ 
    background:linear-gradient(180deg,#ffffff,#fafcff)!important; 
    border-color:#e6ecf9!important; 
    padding:14px 16px!important;
  }
  .title .ttext{
    font-size:23px!important;
    line-height:1.22!important;
    letter-spacing:.02em!important;
    text-wrap:balance;
    -webkit-font-smoothing:antialiased;
    font-weight:900!important;
  }
  @media (min-width:860px){ .title .ttext{ font-size:26px!important; } }
  .title .ttext::before{
    width:4px!important; height:1.15em!important; border-radius:6px!important;
    background:linear-gradient(180deg,#7cc5ff,#36d3ee)!important;
    box-shadow:0 1px 2px rgba(54, 211, 238, .25);
    margin-right:8px!important;
  }

  /* --- v7.9 heading clean-up --- */
  .ttext{ 
    color:#0b1324 !important; 
    background:none !important; 
    -webkit-background-clip:initial !important; 
    background-clip:initial !important;
  }
  .title .ttext::before{ display:none !important; }
  /* subtle gradient border on title container */
  .title{
    border:1px solid transparent !important;
    background:
      linear-gradient(180deg,#ffffff,#fafcff) padding-box,
      linear-gradient(90deg, rgba(34,211,238,.18), rgba(59,130,246,.18)) border-box !important;
  }
</style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0ea5e9">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

</head>
<body>
<div class="bg-anim"></div>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="brand-badge" aria-hidden="true"></div>
      <h1 class="brand-text">SPACED RECALL PRO</h1>
    </div>
    <div class="toolbar">
      <button class="btn primary" id="goStudy" data-target="viewStudy">学習</button>
      <button class="btn" id="goAdd" data-target="viewAdd">追加</button>
      <button class="btn" id="goList" data-target="viewList">一覧</button>
      <button class="btn" id="goStats" data-target="viewStats">統計</button>
      <span class="chip">学習タグ: <select id="tagFilter"><option value="">全て</option></select></span>
      <span class="chip">今日の残り: <b id="dueCount">0</b></span>
      <span class="chip">総カード: <b id="totalCount">0</b></span>
      <span class="chip">TTS: <label><input type="checkbox" id="ttsToggle"></label></span>
      <button class="btn" id="wrongOnlyBtn" title="直近ミスだけで復習">復習: ミスだけ OFF</button>
      <button class="btn timer-toggle" id="toggleTimer">⏱ タイマー</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- Study View -->
  <section id="viewStudy" class="card fade">
    <div class="inner">
      <div id="studyFace" class="segblock anim-liquid">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="muted">SM-2間隔反復 / 出題方向: <select id="dirMode">
            <option value="auto">自動（英→日/日→英）</option>
            <option value="en2ja">英→日</option>
            <option value="ja2en">日→英</option>
          </select></div>
          <div class="row">
            <div class="ring" id="ring" title="今日の進捗"><div class="ring-label" id="ringLabel">0%</div></div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="prompt" id="prompt">ここに問題が出るよ</div>
        <div class="row" style="justify-content:center; gap:8px; margin:6px 0 2px">
          <button class="btn" id="speakBtn" title="英語を読み上げ">🔊 読み上げ</button>
          <button class="btn" id="noteBtn" title="ヒント表示">💡 ヒント</button>
        </div>
      </div>

      <div class="segblock">
        <div class="row" style="justify-content:center">
          <button class="btn reveal" id="revealBtn">答え</button>
          <button class="btn bad" id="btnAgain">まだ</button>
          <button class="btn mid" id="btnHard">ふつう</button>
          <button class="btn good" id="btnGood">覚えた</button>
        </div>
        <div class="answer hidden" id="answer"></div>
        <div id="noteBox" class="note hidden"></div>
        <div class="muted" style="margin-top:8px">※ 「覚えた」「ふつう」「まだ」で次回の出題間隔が自動調整されます。</div>
        <div class="row" style="margin-top:14px;justify-content:center">
          <canvas id="spark" width="560" height="80" style="width:100%;max-width:560px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.6)"></canvas>
        </div>
        <div class="muted" id="lastNote" style="text-align:center;margin-top:6px"></div>
      </div>

      <div class="segblock">
        <div class="tvbar">
          <span class="pill active" data-pc="seq">履歴（回数x結果）</span>
          <span class="pill" data-pc="totals">合計（正/誤/回）</span>
          <span class="pill" data-pc="streak">連勝推移</span>
          <span style="margin-left:auto"></span>
          <span class="title-tag">CARD INSIGHT</span>
        </div>
        <canvas id="pcMain" width="1040" height="300" style="width:100%;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.92)"></canvas>
        <canvas id="pcInd" width="1040" height="120" style="width:100%;margin-top:10px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.92)"></canvas>
      </div>
    </div>
  </section>

  <!-- Add View -->
  <section id="viewAdd" class="card hidden fade">
    <div class="inner">
      <h2 class="title"><span class="ttext">カード追加</span></h2>
      <div class="segblock">
        <div class="grid">
          <div><label>英語（Front）</label><input id="inFront" placeholder="economy"></div>
          <div><label>日本語（Back）</label><input id="inBack" placeholder="経済"></div>
        </div>
        <div class="divider"></div>
        <div class="grid" style="margin-top:8px">
          <div><label>タグ（任意）</label><input id="inTag" placeholder="重要200"></div>
          <div><label>メモ/ヒント（任意）</label><textarea id="inNote" placeholder="例）例文・コアイメージ・語源など"></textarea></div>
        </div>
        <div class="row" style="margin-top:10px"><button class="btn primary" id="btnAddCard">追加</button></div>
      </div>

      <h3 class="title"><span class="ttext g2">一括追加（ペースト可）</span></h3>
      <div class="segblock">
        <div class="muted">1行1語で、<b>英語, 日本語</b> または <b>英語のみ</b> を貼り付け。区切り: カンマ, / タブ / : / - / スペース2個以上。</div>
        <textarea id="bulkBox" placeholder="economy, 経済&#10;budget, 予算&#10;revenue, 収入"></textarea>
        <div class="row" style="margin-top:8px">
          <input id="bulkTag" placeholder="一括タグ（任意）" style="max-width:260px">
          <button class="btn primary" id="btnBulkAdd">一括追加</button>
          <button class="btn" id="btnExport">エクスポート</button>
          <label class="btn">インポート<input type="file" id="fileImport" accept="application/json" class="hidden"></label>
        </div>
      </div>
    </div>
  </section>

  <!-- List View -->
  <section id="viewList" class="card hidden fade">
    <div class="inner">
      <h2 class="title"><span class="ttext g3">カード一覧</span></h2>
      <div class="segblock">
        <div class="row" style="margin-bottom:8px">
          <input id="search" placeholder="検索（英/和/タグ/メモ）">
          <button class="btn" id="btnSortNext">次回が近い順</button>
          <button class="btn" id="btnSortFront">英語A→Z</button>
        </div>
        <div class="divider"></div>
        <div style="max-height:48vh;overflow:auto">
          <table id="tbl"><thead><tr>
            <th>#</th><th>Front</th><th>Back</th><th>Tag</th><th>メモ</th><th>EF</th><th>間隔</th><th>次回</th><th>削除</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>

  <!-- Stats View -->
  <section id="viewStats" class="card hidden fade">
    <div class="inner">
      <h2 class="title"><span class="ttext g4">統計</span></h2>
      <div class="segblock">
        <div class="tvbar">
          <span class="pill active" data-m="acc">正答率</span>
          <span class="pill" data-m="vol">レビュー数</span>
          <span class="pill" data-m="diff">難度</span>
          <span class="pill" data-m="ef">EF分布</span>
          <span class="pill" data-m="rank">単語ランキング</span>
          <span style="flex:1"></span>
          <span class="pill active" data-t="14">14D</span>
          <span class="pill" data-t="30">30D</span>
          <span class="pill" data-t="90">90D</span>
        </div>
        <div id="chartWrap">
          <canvas id="tvMain" width="980" height="360" style="width:100%;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.92)"></canvas>
          <canvas id="tvInd" width="980" height="140" style="width:100%;margin-top:10px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.92)"></canvas>
        </div>
        <div id="rankWrap" class="hidden" style="margin-top:12px">
          <table><thead><tr><th>順位</th><th>単語</th><th>意味</th><th>誤答率</th><th>間違い回数</th></tr></thead><tbody id="rankBody"></tbody></table>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Timer Panel + FAB -->
<div id="timerPanel" class="timer-panel hidden" aria-hidden="true">
  <div class="timer-head">
    <div class="seg" role="tablist" aria-label="Timer Modes">
      <button class="seg-btn active" data-tm="stopwatch">ストップ</button>
      <button class="seg-btn" data-tm="timer">タイマー</button>
      <button class="seg-btn" data-tm="pomodoro">ポモドロ</button>
    </div>
    <button class="btn" id="closeTimer" style="margin-left:auto">×</button>
  </div>
  <div id="panelStopwatch">
    <div class="time-big" id="swTime">00:00.0</div>
    <div class="timer-row">
      <button class="btn primary" id="swStart">開始</button>
      <button class="btn" id="swLap">ラップ</button>
      <button class="btn bad" id="swReset">リセット</button>
    </div>
    <ul id="swLaps" style="max-height:120px; overflow:auto; margin:8px 0 0 0; padding-left:18px"></ul>
  </div>
  <div id="panelTimer" class="hidden">
    <div class="time-big" id="tmTime">10:00</div>
    <div class="timer-row" style="margin-bottom:6px">
      <input id="tmMin" type="number" min="1" max="240" value="10" style="width:100px"> 分
      <button class="btn" id="tmSet">設定</button>
      <button class="btn primary" id="tmStart">開始</button>
      <button class="btn bad" id="tmStop">停止</button>
    </div>
    <div class="timer-row">
      <button class="btn" data-preset="25">25分</button>
      <button class="btn" data-preset="15">15分</button>
      <button class="btn" data-preset="5">5分</button>
    </div>
  </div>
  <div id="panelPomodoro" class="hidden">
    <div class="time-big" id="pmTime">25:00</div>
    <div class="timer-row">
      <button class="btn primary" id="pmStart">開始</button>
      <button class="btn bad" id="pmStop">停止</button>
    </div>
    <div class="muted" style="text-align:center">25分作業 → 5分休憩を自動ループ</div>
  </div>
</div>
<button id="fabTimer" class="btn primary" title="タイマー">⏱</button>

<script>
// ------- Data Model -------
const STORAGE_KEY = "keiya_spaced_v7_6";
const LOG_KEY = "keiya_spaced_v7_6_logs";
function now(){ return Date.now(); }
function days(n){ return n*24*60*60*1000; }
function fmt(ts){ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }

function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return []; const arr = JSON.parse(raw); return Array.isArray(arr)?arr:[]; }catch(e){ return []; } }
function save(cards){ localStorage.setItem(STORAGE_KEY, JSON.stringify(cards)); }
function loadLogs(){ try{ const raw = localStorage.getItem(LOG_KEY); if(!raw) return []; const arr = JSON.parse(raw); return Array.isArray(arr)?arr:[]; }catch(e){ return []; } }
function saveLogs(logs){ localStorage.setItem(LOG_KEY, JSON.stringify(logs)); }

const RECOMMENDED = { list: [
  {
    "front": "economy",
    "back": "経済"
  }
] };

function seedIfEmpty(){
  let cards = load();
  if(cards.length) return cards;
  const ts = now();
  cards = RECOMMENDED.list.map(x=>({id:crypto.randomUUID(),front:x.front,back:x.back,tag:"重要200",note:"",ef:2.5,interval:0,reps:0,due:ts,createdAt:ts,correct:0,wrong:0}));
  save(cards); saveLogs([]);
  return cards;
}

// ------- Scheduler (SM-2 light) -------
function schedule(card, quality){
  card.ef = Math.max(1.3, card.ef + (0.1 - (5 - quality) * (0.08 + (5 - quality)*0.02)));
  if(quality < 3){ card.reps = 0; card.interval = 0; card.due = now() + days(1); return; }
  if(card.reps === 0) card.interval = 1;
  else if(card.reps === 1) card.interval = 3;
  else card.interval = Math.round(card.interval * card.ef);
  card.reps += 1;
  card.due = now() + days(card.interval);
}

// ------- State -------
let CARDS = seedIfEmpty();
let LOGS = loadLogs();
let CURRENT_ID = null;
let REVEAL = false;
let DIR_MODE = "auto";
let TODAY_GOAL = 80;
let TODAY_COUNT = 0;
let TTS_ON = false;
let WRONG_ONLY = localStorage.getItem('wrongOnly')==='1';
const WRONG_WINDOW = 200;
const ANIM_MS = 800;

updateCounts();

// ------- NAV ACTIVE -------
const navBtns = Array.from(document.querySelectorAll('.toolbar .btn[data-target]'));
function setActiveNav(viewId){
  navBtns.forEach(b=> b.classList.toggle('primary', b.dataset.target===viewId));
}
function show(id){
  ['viewStudy','viewAdd','viewList','viewStats'].forEach(v=>document.getElementById(v).classList.toggle('hidden', v!==id));
  setActiveNav(id);
  if(id==="viewList") renderList();
  if(id==="viewStats") renderStats(true);
  if(id==="viewStudy") { pickNext(); renderPerCard(true); }
}
navBtns.forEach(b=> b.onclick=()=> show(b.dataset.target));

// ------- Wrong-only toggle -------
const wrongBtn = document.getElementById('wrongOnlyBtn');
function renderWrongBtn(){
  wrongBtn.textContent = '復習: ミスだけ ' + (WRONG_ONLY? 'ON':'OFF');
  wrongBtn.classList.toggle('primary', WRONG_ONLY);
}
renderWrongBtn();
wrongBtn.onclick=()=>{ WRONG_ONLY=!WRONG_ONLY; localStorage.setItem('wrongOnly', WRONG_ONLY?'1':'0'); renderWrongBtn(); pickNext(); };

// ------- Study logic -------
function poolByTag(){
  const tag = document.getElementById("tagFilter").value;
  return tag ? CARDS.filter(c=>c.tag===tag) : CARDS.slice();
}
function getWrongSet(){
  const logs = LOGS.slice(-WRONG_WINDOW);
  const lastWrong = new Map();
  for(const l of logs){ lastWrong.set(l.id, l.ok? 1 : 0); }
  const ids = new Set([...lastWrong.entries()].filter(([id,ok])=> ok===0).map(([id])=>id));
  CARDS.forEach(c=>{ if((c.tag||'').includes('要強化')) ids.add(c.id); });
  return ids;
}
function getDueQueue(){
  let pool = poolByTag();
  if(WRONG_ONLY){
    const ids = getWrongSet();
    pool = pool.filter(c=> ids.has(c.id));
    if(pool.length===0){ pool = poolByTag(); }
  }
  return pool.filter(c=>c.due <= now()).sort((a,b)=>a.due-b.due);
}
function randomDir(){ return Math.random()<0.5 ? "en2ja" : "ja2en"; }

function pickNext(){
  const due = getDueQueue();
  const pool = WRONG_ONLY ? poolByTag().filter(c=> getWrongSet().has(c.id)) : poolByTag();
  const sel = due.length ? due[0] : pool.sort((a,b)=>a.due-b.due)[0];
  const prompt = document.getElementById("prompt");
  const answer = document.getElementById("answer");
  const lastNote = document.getElementById("lastNote");
  const noteBox = document.getElementById("noteBox"); noteBox.classList.add('hidden'); noteBox.textContent='';
  if(!sel){ CURRENT_ID=null; prompt.textContent="今日の分は終了！カードを追加するか明日また来てね"; answer.classList.add("hidden"); answer.textContent=""; updateCounts(); drawSpark([]); lastNote.textContent=""; renderPerCard(true); return; }
  CURRENT_ID = sel.id;
  const dir = DIR_MODE==="auto" ? randomDir() : DIR_MODE;
  sel._dir = dir;
  if(dir==="en2ja"){ prompt.textContent = sel.front; answer.textContent = sel.back || "(未入力)"; }
  else{ prompt.textContent = sel.back || "(未入力)"; answer.textContent = sel.front; }
  answer.classList.add("hidden"); REVEAL=false;
  updateCounts();
  if(TTS_ON){ speak(prompt.textContent); }
  const hist = LOGS.filter(l=>l.id===sel.id).slice(-8);
  const msg = hist.length ? "最近の正誤: " + hist.map(h=>h.ok?"○":"×").join(" ") : "初出題";
  lastNote.textContent = msg;
  drawSpark(hist);
  renderPerCard(true);
}

function speak(text, lang){
  try{ const u = new SpeechSynthesisUtterance(text); u.lang = lang || (/[A-Za-z]/.test(text) ? "en-US" : "ja-JP"); speechSynthesis.cancel(); speechSynthesis.speak(u); }catch{}
}
function speakCurrentEnglish(){
  const card = CARDS.find(c=>c.id===CURRENT_ID); if(!card) return;
  const dir = card._dir || "en2ja";
  const text = dir==="en2ja" ? (card.front||"") : (card.back||"");
  speak(text, "en-US");
}

function grade(q){
  if(!CURRENT_ID) return;
  const idx = CARDS.findIndex(c=>c.id===CURRENT_ID);
  if(idx<0) return;
  const c = CARDS[idx];
  const prev = typeof c.last === 'number' ? c.last : -1;
  const ok = q>=3 ? 1 : 0;
  LOGS.push({id:c.id, ts:now(), ok: !!ok});
  if(LOGS.length>80000) LOGS = LOGS.slice(-60000);
  saveLogs(LOGS);
  schedule(c, q);
  if(ok) c.correct=(c.correct||0)+1; else c.wrong=(c.wrong||0)+1;
  c.last = ok; c.lastTs = now();
  updateLeech(c);
  save(CARDS);
  TODAY_COUNT++;
  const lastNote = document.getElementById("lastNote");
  if(prev===1 && ok===0) lastNote.textContent = "今回 × / 前回 ○（一時的な後退。次回すぐ復活できる！）";
  else if(prev===0 && ok===1) lastNote.textContent = "今回 ○ / 前回 ×（いい回復！）";
  else lastNote.textContent = ok? "連続正解中": "復習強化ポイント";
  if(TODAY_COUNT % 50 === 0 && ok===1) confetti();
  pickNext();
}

document.getElementById("revealBtn").onclick=()=>{ document.getElementById("answer").classList.toggle("hidden"); if(!REVEAL && TTS_ON) speak(document.getElementById("answer").textContent); REVEAL=!REVEAL; };
document.getElementById("btnAgain").onclick=()=>grade(1);
document.getElementById("btnHard").onclick=()=>grade(3);
document.getElementById("btnGood").onclick=()=>grade(5);

document.getElementById("dirMode").onchange=(e)=>{ DIR_MODE=e.target.value; pickNext(); };
document.getElementById("ttsToggle").onchange=(e)=>{ TTS_ON=e.target.checked; };
document.getElementById('speakBtn').onclick = ()=>speakCurrentEnglish();
document.getElementById('noteBtn').onclick = ()=>{
  const card = CARDS.find(c=>c.id===CURRENT_ID); if(!card) return;
  const box = document.getElementById('noteBox');
  if(card.note && card.note.trim()){
    box.textContent = card.note; box.classList.toggle('hidden');
  }else{
    box.textContent = "（メモは未登録です。カード一覧や追加画面から書けます）";
    box.classList.remove('hidden');
  }
};

// ------- Add / Bulk / Import / Export -------
document.getElementById("btnAddCard").onclick=()=>{
  const f = document.getElementById("inFront").value.trim();
  const b = document.getElementById("inBack").value.trim();
  const t = document.getElementById("inTag").value.trim();
  const n = document.getElementById("inNote").value.trim();
  if(!f && !b) return;
  const ts=now();
  CARDS.push({id:crypto.randomUUID(),front:f||"",back:b||"",tag:t||"",note:n||"",ef:2.5,interval:0,reps:0,due:ts,createdAt:ts,correct:0,wrong:0});
  save(CARDS); document.getElementById("inFront").value=""; document.getElementById("inBack").value=""; document.getElementById("inNote").value=""; updateCounts(); pickNext();
};
document.getElementById("btnBulkAdd").onclick=()=>{
  const text = document.getElementById("bulkBox").value;
  const tag = document.getElementById("bulkTag").value.trim();
  let added=0; const ts=now();
  text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).forEach(line=>{
    const parts = line.split(/\s{2,}|,|:|-|\t/).map(s=>s.trim()).filter(Boolean);
    if(parts.length>=2){ CARDS.push({id:crypto.randomUUID(),front:parts[0],back:parts.slice(1).join(" "),tag, note:"", ef:2.5,interval:0,reps:0,due:ts,createdAt:ts,correct:0,wrong:0}); added++; }
    else if(parts.length===1){ CARDS.push({id:crypto.randomUUID(),front:parts[0],back:"",tag, note:"", ef:2.5,interval:0,reps:0,due:ts,createdAt:ts,correct:0,wrong:0}); added++; }
  });
  save(CARDS); alert(added+" 語を追加しました"); document.getElementById("bulkBox").value=""; updateCounts();
};
document.getElementById("btnExport").onclick=()=>{
  const data = JSON.stringify(CARDS, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download="cards.json"; a.click();
  URL.revokeObjectURL(url);
};
document.getElementById("fileImport").addEventListener("change", e=>{
  const f=e.target.files&&e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{
    try{ const incoming=JSON.parse(r.result); if(!Array.isArray(incoming)) throw new Error("format");
      const map=new Map(CARDS.map(c=>[c.id,c]));
      for(const c of incoming){ if(c&&c.id&&map.has(c.id)) map.set(c.id,{...map.get(c.id),...c}); else if(c&&c.front){
            c.id=c.id||crypto.randomUUID(); c.ef=c.ef??2.5; c.interval=c.interval??0; c.reps=c.reps??0; c.due=c.due??now(); c.createdAt=c.createdAt??now(); c.correct=c.correct??0; c.wrong=c.wrong??0; c.note=c.note||""; map.set(c.id,c);
      }}
      CARDS=Array.from(map.values()); save(CARDS); alert("インポート完了"); updateCounts(); renderList(); pickNext();
    }catch(e){ alert("インポート失敗"); }
  }; r.readAsText(f);
});

// ------- Leech detection -------
function updateLeech(card){
  const logs = LOGS.filter(l=>l.id===card.id).slice(-10);
  const wrongs = logs.filter(l=>!l.ok).length;
  const rate = logs.length? wrongs/logs.length : 0;
  const isLeech = (wrongs>=4 && rate>=0.5);
  if(isLeech){
    if(!((card.tag||'').includes('要強化'))) card.tag = (card.tag? card.tag+' ':'') + '要強化';
    card.due = Math.min(card.due, now() + days(1));
  }
}

// ------- List (edit/delete) -------
function renderList(){
  const q = document.getElementById("search").value.trim().toLowerCase();
  const tbody = document.querySelector("#tbl tbody"); tbody.innerHTML="";
  const data = CARDS.filter(c=>!q || (c.front.toLowerCase().includes(q) || (c.back||"").toLowerCase().includes(q) || (c.tag||"").toLowerCase().includes(q) || (c.note||"").toLowerCase().includes(q)));
  data.forEach((c,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td>
      <td><input value="${escapeHtml(c.front)}" data-k="front"></td>
      <td><input value="${escapeHtml(c.back||"")}" data-k="back"></td>
      <td><input value="${escapeHtml(c.tag||"")}" data-k="tag"></td>
      <td><input value="${escapeHtml(c.note||"")}" data-k="note"></td>
      <td>${c.ef.toFixed(2)}</td><td>${c.interval}</td><td>${fmt(c.due)}</td>
      <td><button class="btn bad" data-del="${c.id}">削除</button></td>`;
    tr.querySelectorAll("input,textarea").forEach(inp=>{
      inp.onchange = (e)=>{ const k=inp.dataset.k; c[k]=inp.value; save(CARDS); };
    });
    tr.querySelector("[data-del]").onclick=()=>{ if(confirm("削除しますか？")){ CARDS=CARDS.filter(x=>x.id!==c.id); save(CARDS); renderList(); updateCounts(); } };
    tbody.appendChild(tr);
  });
}
document.getElementById("search").oninput=()=>renderList();
document.getElementById("btnSortNext").onclick=()=>{ CARDS.sort((a,b)=>a.due-b.due); renderList(); };
document.getElementById("btnSortFront").onclick=()=>{ CARDS.sort((a,b)=> (a.front||"").localeCompare(b.front||"")); renderList(); };

// ------- App-level Stats with ANIMATION -------
let TV_MODE = "acc"; let TV_RANGE = 14;
const pillsM = Array.from(document.querySelectorAll('.pill[data-m]'));
const pillsT = Array.from(document.querySelectorAll('.pill[data-t]'));
pillsM.forEach(el=> el.onclick=()=>{ pillsM.forEach(p=>p.classList.remove('active')); el.classList.add('active'); TV_MODE = el.dataset.m; renderStats(true); });
pillsT.forEach(el=> el.onclick=()=>{ pillsT.forEach(p=>p.classList.remove('active')); el.classList.add('active'); TV_RANGE = parseInt(el.dataset.t); renderStats(true); });

function renderStats(animate=false){
  document.getElementById("rankWrap").classList.toggle("hidden", TV_MODE!=="rank");
  document.getElementById("chartWrap").classList.toggle("hidden", TV_MODE==="rank");
  if(TV_MODE==="rank"){ renderRanking && renderRanking(); return; }
  drawTV(document.getElementById("tvMain"), document.getElementById("tvInd"), TV_MODE, TV_RANGE, animate);
}

function ease(t){ return t<.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2; }

function getDailyMap(daysCount){
  const map = new Map(); const today=new Date();
  for(let i=daysCount-1;i>=0;i--){ const d=new Date(today); d.setDate(today.getDate()-i); const key=fmt(d.getTime()); map.set(key,{t:0,c:0}); }
  for(const l of LOGS){ const key=fmt(l.ts); if(map.has(key)){ const o=map.get(key); o.t++; if(l.ok) o.c++; map.set(key,o); } }
  const labels = Array.from(map.keys());
  const total=labels.map(k=>map.get(k).t); const correct=labels.map(k=>map.get(k).c);
  return {labels, total, correct};
}

function drawTV(main, ind, mode, range, animate){
  const m=main.getContext("2d"); const i=ind.getContext("2d");
  const W=main.width, H=main.height, pad=40;
  const {labels,total,correct} = getDailyMap(range);
  const acc = total.map((t,idx)=> t? correct[idx]/t : 0);
  const vol = total;
  const diff = total.map((t,idx)=> t? 1 - acc[idx] : 0);

  function grid(ctx){
    ctx.strokeStyle="#e4ebfb"; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.moveTo(pad, pad); ctx.lineTo(pad, H-pad); ctx.stroke();
    ctx.setLineDash([4,6]); ctx.strokeStyle="#edf2ff";
    for(let r=1;r<4;r++){ const y = pad + (H-2*pad)*r/4; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke(); }
    ctx.setLineDash([]);
  }

  const X = (idx)=> pad + idx*(W-2*pad)/(labels.length-1 || 1);
  function Y(val, maxV){ return H-pad - val*(H-2*pad)/(maxV||1); }

  function frame(p){
    const t=ease(p);
    m.clearRect(0,0,W,H); i.clearRect(0,0,ind.width,ind.height);
    grid(m);
    if(mode==="acc"){
      const grad = m.createLinearGradient(0,pad,0,H-pad);
      grad.addColorStop(0,"rgba(59,130,246,.35)");
      grad.addColorStop(1,"rgba(34,211,238,.0)");
      m.beginPath(); m.moveTo(pad,H-pad);
      acc.forEach((v,idx)=>{ const x=X(idx), y=Y(v*t,1); m.lineTo(x,y); });
      m.lineTo(X(acc.length-1),H-pad); m.closePath(); m.fillStyle=grad; m.fill();
      const g2 = m.createLinearGradient(pad,0,W-pad,0); g2.addColorStop(0,"#22d3ee"); g2.addColorStop(1,"#3b82f6");
      m.lineWidth=2; m.strokeStyle=g2; m.beginPath();
      acc.forEach((v,idx)=>{ const x=X(idx), y=Y(v*t,1); if(idx===0) m.moveTo(x,y); else m.lineTo(x,y); }); m.stroke();
    }
    else if(mode==="vol"){
      const step = (W-2*pad)/labels.length, bw = step*0.6;
      const max = Math.max(1, Math.max(...vol));
      for(let idx=0; idx<labels.length; idx++){
        const v = (vol[idx]||0) * t;
        const h = (H-2*pad)*v/max;
        const x = pad + idx*step + (step-bw)/2;
        const y = H-pad - h;
        const g = m.createLinearGradient(x,y,x,y+h); g.addColorStop(0,"rgba(34,211,238,.85)"); g.addColorStop(1,"rgba(59,130,246,.85)");
        m.fillStyle=g; m.fillRect(x,y,bw,h);
      }
    }
    else if(mode==="diff"){
      const maxV=1;
      const g2 = m.createLinearGradient(pad,0,W-pad,0); g2.addColorStop(0,"#60a5fa"); g2.addColorStop(1,"#22d3ee");
      m.lineWidth=2; m.strokeStyle=g2; m.beginPath();
      diff.forEach((v,idx)=>{ const x=X(idx), y=Y(v*t,maxV); if(idx===0) m.moveTo(x,y); else m.lineTo(x,y); }); m.stroke();
    }
    m.fillStyle="#667085"; m.font="16px 'Bebas Neue','Rajdhani','M PLUS 1p',system-ui";
    m.textAlign="center"; for(let idx=0; idx<labels.length; idx++) if(idx%Math.ceil(labels.length/8)===0) m.fillText(labels[idx].slice(5), X(idx), H-10);
    m.textAlign="right"; m.fillText("100%", pad-6, pad+6); m.fillText("0%", pad-6, H-pad+6);
  }

  if(animate){
    const t0=performance.now();
    (function loop(t){
      const p=Math.min(1,(t-t0)/ANIM_MS); frame(p); if(p<1) requestAnimationFrame(loop);
    })(performance.now());
  }else{
    frame(1);
  }
}

// ------- Per-Card Charts with ANIMATION -------
let PC_MODE = "seq"; // seq | totals | streak
const pcPills = Array.from(document.querySelectorAll('.pill[data-pc]'));
pcPills.forEach(el=> el.onclick=()=>{ pcPills.forEach(p=>p.classList.remove('active')); el.classList.add('active'); PC_MODE = el.dataset.pc; renderPerCard(true); });

function getCardLogs(id){
  const arr = LOGS.filter(l=>l.id===id).sort((a,b)=>a.ts-b.ts);
  return arr;
}

function renderPerCard(animate=false){
  const main = document.getElementById('pcMain');
  const ind  = document.getElementById('pcInd');
  const m = main.getContext('2d'), i = ind.getContext('2d');
  const W=main.width,H=main.height,pad=40;
  const logs = CURRENT_ID ? getCardLogs(CURRENT_ID) : [];
  const total = logs.length, correct = logs.filter(l=>l.ok).length, wrong = total - correct;

  function grid(ctx){
    ctx.strokeStyle="#e4ebfb"; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.moveTo(pad, pad); ctx.lineTo(pad, H-pad); ctx.stroke();
    ctx.setLineDash([4,6]); ctx.strokeStyle="#edf2ff";
    for(let r=1;r<4;r++){ const y = pad + (H-2*pad)*r/4; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke(); }
    ctx.setLineDash([]);
    m.fillStyle="#667085"; m.font="16px 'Bebas Neue','Rajdhani','M PLUS 1p',system-ui";
    m.textAlign="right"; m.fillText("1", pad-6, pad+6); m.fillText("0", pad-6, H-pad+6);
  }

  function drawTotalsOn(ctx, width, height, pad2, p){
    const W2=width, H2=height;
    ctx.clearRect(0,0,W2,H2);
    ctx.strokeStyle="#e4ebfb"; ctx.beginPath(); ctx.moveTo(pad2,H2-pad2); ctx.lineTo(W2-pad2,H2-pad2); ctx.moveTo(pad2,pad2); ctx.lineTo(pad2,H2-pad2); ctx.stroke();
    const max = Math.max(1, total);
    const bw = (W2-2*pad2)/6;
    const x1 = pad2 + bw*1, x2 = pad2 + bw*3, x3 = pad2 + bw*5;
    function bar(x, v, c1,c2){
      const vv=v*p;
      const h = (H2-2*pad2) * vv/max;
      const y = H2-pad2 - h;
      const g = ctx.createLinearGradient(x,y,x,y+h); g.addColorStop(0,c1); g.addColorStop(1,c2);
      ctx.fillStyle=g; ctx.fillRect(x-bw/2,y,bw,h);
    }
    bar(x1, total, "rgba(125,211,252,.9)","rgba(59,130,246,.9)");
    bar(x2, correct,"rgba(16,185,129,.9)","rgba(110,231,183,.9)");
    bar(x3, wrong,  "rgba(239,68,68,.9)","rgba(252,165,165,.9)");
    ctx.fillStyle="#0b1324"; ctx.font="16px 'Bebas Neue','Rajdhani','M PLUS 1p',system-ui"; ctx.textAlign="center";
    ctx.fillText("回数 "+total, x1, pad2-6);
    ctx.fillText("正解 "+correct, x2, pad2-6);
    ctx.fillText("誤答 "+wrong, x3, pad2-6);
  }

  function frame(p){
    m.clearRect(0,0,W,H); i.clearRect(0,0,ind.width,ind.height);
    if(total===0){
      m.fillStyle="#667085"; m.font="18px 'M PLUS 1p',system-ui"; m.textAlign="center"; m.fillText("このカードはまだ学習履歴がありません", W/2, H/2);
      return;
    }
    if(PC_MODE==="seq"){
      grid(m);
      const step = (W-2*pad)/Math.max(1,total);
      for(let idx=0; idx<total; idx++){
        const x = pad + idx*step + step*0.1;
        const bw = step*0.8;
        const ok = logs[idx].ok ? 1 : 0;
        const y = pad + (H-2*pad) * (1-ok*p);
        const g = m.createLinearGradient(x,y,x,y+(H-pad-y));
        g.addColorStop(0, ok ? "rgba(16,185,129,.9)" : "rgba(239,68,68,.9)");
        g.addColorStop(1, ok ? "rgba(16,185,129,.4)" : "rgba(239,68,68,.4)");
        m.fillStyle = g; m.fillRect(x, y, bw, (H-pad)-y);
      }
      drawTotalsOn(i, ind.width, ind.height, 40, p);
    } else if(PC_MODE==="streak"){
      grid(m);
      const step = (W-2*pad)/Math.max(1,total-1);
      let streak=0; const vals=[];
      for(const l of logs){ streak = l.ok ? streak+1 : 0; vals.push(streak); }
      const maxV = Math.max(1, ...vals);
      const X = (i)=> pad + i*step;
      const Y = (v)=> H-pad - v*(H-2*pad)/maxV;
      const g = m.createLinearGradient(pad,0,W-pad,0); g.addColorStop(0,"#22d3ee"); g.addColorStop(1,"#3b82f6");
      m.lineWidth=2; m.strokeStyle=g; m.beginPath();
      vals.forEach((v,idx)=>{ const x=X(idx), y=Y(v*p); if(idx===0) m.moveTo(x,y); else m.lineTo(x,y); });
      m.stroke();
      m.fillStyle="#3b82f6"; vals.forEach((v,idx)=>{ const x=X(idx), y=Y(v*p); m.beginPath(); m.arc(x,y,3,0,Math.PI*2); m.fill(); });
      drawTotalsOn(i, ind.width, ind.height, 40, p);
    } else if(PC_MODE==="totals"){
      grid(m);
      drawTotalsOn(m, W, H, 50, p);
      i.clearRect(0,0,ind.width,ind.height);
    }
  }

  if(animate){
    const t0=performance.now();
    (function loop(t){
      const p=Math.min(1,(t-t0)/ANIM_MS); frame(ease(p)); if(p<1) requestAnimationFrame(loop);
    })(performance.now());
  }else{
    frame(1);
  }
}


// ------- Timer Robust Toggle -------
const panel = document.getElementById('timerPanel');
function openTimer(show){
  panel.classList.toggle('hidden', !show);
  panel.setAttribute('aria-hidden', show? 'false' : 'true');
  localStorage.setItem('timerOpen',''+(show?1:0));
}
function toggleTimer(){ openTimer(panel.classList.contains('hidden')); }
document.getElementById('toggleTimer').addEventListener('click', toggleTimer);
document.getElementById('fabTimer').addEventListener('click', toggleTimer);
document.getElementById('closeTimer').addEventListener('click', ()=> openTimer(false));
document.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='t') toggleTimer(); });

// Timer tabs
const segBtns = Array.from(panel.querySelectorAll('.seg-btn'));
segBtns.forEach(el=> el.addEventListener('click', ()=>{
  segBtns.forEach(p=>p.classList.remove('active')); el.classList.add('active');
  ['panelStopwatch','panelTimer','panelPomodoro'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  if(el.dataset.tm==='stopwatch') document.getElementById('panelStopwatch').classList.remove('hidden');
  if(el.dataset.tm==='timer') document.getElementById('panelTimer').classList.remove('hidden');
  if(el.dataset.tm==='pomodoro') document.getElementById('panelPomodoro').classList.remove('hidden');
}));

// Stopwatch
let swInt=null, swStartTs=0, swElapsed=0;
function fmtMs(ms){ const m = Math.floor(ms/60000); const s = Math.floor((ms%60000)/1000); const d = Math.floor((ms%1000)/100); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${d}`; }
function swTick(){ const ms = Date.now()-swStartTs+swElapsed; document.getElementById('swTime').textContent = fmtMs(ms); }
document.getElementById('swStart').onclick=()=>{
  if(swInt){ clearInterval(swInt); swInt=null; swElapsed += Date.now()-swStartTs; document.getElementById('swStart').textContent='再開'; }
  else { swStartTs=Date.now(); swInt=setInterval(swTick, 100); document.getElementById('swStart').textContent='一時停止'; }
};
document.getElementById('swLap').onclick=()=>{
  const li=document.createElement('li'); li.textContent=document.getElementById('swTime').textContent; document.getElementById('swLaps').prepend(li);
};
document.getElementById('swReset').onclick=()=>{ clearInterval(swInt); swInt=null; swElapsed=0; document.getElementById('swTime').textContent='00:00.0'; document.getElementById('swStart').textContent='開始'; document.getElementById('swLaps').innerHTML=''; };

// Timer
let tmInt=null, tmRemain=600000;
function fmtSec(sec){ const m=Math.floor(sec/60), s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
function tmRender(){ document.getElementById('tmTime').textContent = fmtSec(Math.max(0, Math.ceil(tmRemain/1000))); }
function tmBeep(){ try{ const ac=new (window.AudioContext||window.webkitAudioContext)(); const o=ac.createOscillator(); const g=ac.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ac.destination); g.gain.setValueAtTime(0.001, ac.currentTime); g.gain.exponentialRampToValueAtTime(0.2, ac.currentTime+0.05); o.start(); o.stop(ac.currentTime+0.3); }catch{} }
document.getElementById('tmSet').onclick=()=>{ const m=parseInt(document.getElementById('tmMin').value||'10'); tmRemain=m*60000; tmRender(); };
document.getElementById('tmStart').onclick=()=>{
  if(tmInt) return;
  let last=Date.now();
  tmInt=setInterval(()=>{ const nowT=Date.now(); tmRemain-= (nowT-last); last=nowT; tmRender(); if(tmRemain<=0){ clearInterval(tmInt); tmInt=null; tmBeep(); alert('タイマー終了'); } }, 200);
};
document.getElementById('tmStop').onclick=()=>{ clearInterval(tmInt); tmInt=null; };
panel.querySelectorAll('#panelTimer [data-preset]').forEach(btn=> btn.onclick=()=>{ document.getElementById('tmMin').value=btn.dataset.preset; document.getElementById('tmSet').click(); });

// Pomodoro
let pmInt=null, pmRemain=25*60000, pmBreak=false;
function pmRender(){ document.getElementById('pmTime').textContent = fmtSec(Math.max(0, Math.ceil(pmRemain/1000))); }
document.getElementById('pmStart').onclick=()=>{
  if(pmInt) return;
  let last=Date.now();
  pmInt=setInterval(()=>{
    const nowT=Date.now(); pmRemain-= (nowT-last); last=nowT; pmRender();
    if(pmRemain<=0){
      tmBeep();
      pmBreak=!pmBreak;
      pmRemain = pmBreak? 5*60000 : 25*60000;
      alert(pmBreak? '休憩5分！' : '作業25分スタート！');
    }
  }, 200);
};
document.getElementById('pmStop').onclick=()=>{ clearInterval(pmInt); pmInt=null; pmRemain=25*60000; pmBreak=false; pmRender(); };

// Helpers
function updateCounts(){
  document.getElementById("dueCount").textContent = getDueQueue().length;
  document.getElementById("totalCount").textContent = CARDS.length;
  const sel = document.getElementById("tagFilter");
  const before = sel.value;
  const tags = Array.from(new Set(CARDS.map(c=>c.tag).filter(Boolean))).sort();
  sel.innerHTML = '<option value="">' + "全て" + '</option>' + tags.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
  if(tags.includes(before)) sel.value = before;
  const pct = Math.min(100, Math.round(100*TODAY_COUNT/TODAY_GOAL));
  const ring = document.getElementById("ring"); ring.style.setProperty("--pct", pct+"%");
  document.getElementById("ringLabel").textContent = pct+"%";
}
document.getElementById("tagFilter").onchange=()=>{ pickNext(); updateCounts(); renderPerCard(true); };

function drawSpark(hist){
  const cvs = document.getElementById("spark"); const ctx = cvs.getContext("2d");
  ctx.clearRect(0,0,cvs.width,cvs.height);
  const W=cvs.width,H=cvs.height,pad=12;
  const data = hist.map(h=>h.ok?1:0);
  const n = Math.max(1, data.length);
  const step = (W-pad*2)/Math.max(1,n-1);
  ctx.strokeStyle="#dbe2f2"; ctx.beginPath(); ctx.moveTo(pad,H/2); ctx.lineTo(W-pad,H/2); ctx.stroke();
  const X = (i)=> pad + i*step; const Y = (v)=> H - pad - v*(H-2*pad);
  ctx.lineWidth=2; const g=ctx.createLinearGradient(pad,0,W-pad,0); g.addColorStop(0,"#22d3ee"); g.addColorStop(1,"#3b82f6"); ctx.strokeStyle=g;
  ctx.beginPath(); for(let i=0;i<n;i++){ const x=X(i); const y=Y(data[i]||0); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.stroke();
  for(let i=0;i<n;i++){ const x=X(i),y=Y(data[i]||0); ctx.fillStyle = data[i]? "#10b981" : "#ef4444"; ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); }
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

function confetti(){
  const n=120, dur=1200;
  const div=document.createElement('div'); div.style.position='fixed'; div.style.inset='0'; div.style.pointerEvents='none'; document.body.appendChild(div);
  for(let i=0;i<n;i++){ const s=document.createElement('span'); const size=4+Math.random()*6; s.style.position='absolute'; s.style.left = (Math.random()*100)+'%'; s.style.top='-10px';
    s.style.width=size+'px'; s.style.height=size+'px'; s.style.borderRadius='2px';
    const c = Math.random()<.5 ? '#22d3ee' : '#3b82f6'; s.style.background=c;
    s.style.boxShadow='0 0 8px rgba(59,130,246,.5)'; s.style.transform=`translateY(0) rotate(0deg)`;
    s.style.transition=`transform ${dur}ms ease-out, opacity ${dur}ms ease-out`;
    setTimeout(()=>{ s.style.transform=`translateY(100vh) rotate(${Math.random()*720-360}deg)`; s.style.opacity='0.8'; }, 10);
    div.appendChild(s);
  }
  setTimeout(()=>div.remove(), dur+400);
}

// Restore timer open state & init app
document.addEventListener("DOMContentLoaded", ()=>{
  show("viewStudy");
  const open = localStorage.getItem('timerOpen')==='1';
  if(open) openTimer(true);
});
</script>

<script>
(() => {
  // ===== Graph hotfix (self-contained) =====
  let mode = 'seq'; // 'seq' | 'totals' | 'streak'

  // タブ切替（pill）
  document.querySelectorAll('.pill').forEach(p => {
    p.addEventListener('click', () => {
      document.querySelectorAll('.pill').forEach(x => x.classList.remove('active'));
      p.classList.add('active');
      mode = p.dataset.pc;
      renderCharts();
    });
  });

  // カード識別：いま表示中の問題文（prompt）の文字列をキーにする
  const getCardKey = () => {
    const c = document.getElementById('prompt')?.textContent?.trim() || '';
    return 'srp_stats_' + c;
  };

  const loadArr = () => JSON.parse(localStorage.getItem(getCardKey()) || '[]');
  const saveArr = (arr) => localStorage.setItem(getCardKey(), JSON.stringify(arr));

  // 回答結果を追加（0=まだ,1=ふつう,2=覚えた）
  const pushResult = (r) => {
    const arr = loadArr();
    arr.push({ t: Date.now(), r });
    saveArr(arr);
  };

  // --- Spark（小さな折れ線） ---
  function drawSpark(arr) {
    const c = document.getElementById('spark'); if (!c) return;
    const ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    const n = arr.length || 1;

    ctx.lineWidth = 2;
    ctx.strokeStyle = '#60a5fa';
    ctx.beginPath();
    for (let i = 0; i < n; i++) {
      const x = (c.width - 10) * (i / Math.max(n - 1, 1)) + 5;
      const r = (arr[i]?.r ?? 2);             // 0/1/2
      const y = c.height - 10 - (r / 2) * (c.height - 20);
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    }
    ctx.stroke();
  }

  // --- メインカード（pcMain / pcInd） ---
  function drawPc(arr) {
    const c = document.getElementById('pcMain'); if (!c) return;
    const ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);

    if (mode === 'seq') {
      const w = Math.max(8, (c.width - 40) / Math.max(arr.length, 1) - 4);
      arr.forEach((e, i) => {
        const x = 20 + i * (w + 4);
        const h = ((e.r + 1) / 3) * (c.height - 40);
        const y = c.height - 20 - h;
        ctx.fillStyle = e.r === 2 ? '#93c5fd' : e.r === 1 ? '#fde68a' : '#fecaca';
        ctx.fillRect(x, y, w, h);
      });
    } else if (mode === 'totals') {
      const total = arr.length;
      const good = arr.filter(e => e.r === 2).length;
      const bad  = arr.filter(e => e.r === 0).length;
      const mid  = total - good - bad;
      const vals = [good, mid, bad];
      const labels = ['正', 'ふつう', '誤'];
      const colors = ['#93c5fd', '#fde68a', '#fecaca'];

      const barW = 80, gap = 40;
      const baseX = c.width/2 - (1.5*barW + gap);
      for (let i=0;i<3;i++){
        const h = total ? (vals[i]/total) * (c.height-60) : 0;
        const x = baseX + i*(barW+gap);
        const y = c.height - 30 - h;
        ctx.fillStyle = colors[i];
        ctx.fillRect(x,y,barW,h);
        ctx.fillStyle = '#334155';
        ctx.font = 'bold 16px "M PLUS 1p", system-ui, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(`${labels[i]}:${vals[i]}`, x+barW/2, c.height-10);
      }
    } else {
      // 連勝推移（pcMainに線、pcIndに丸点）
      const seq = arr.map(e => e.r === 2 ? 1 : 0);
      let streak = 0, maxStreak = 1;
      const X = (i, n, pad=20) => pad + i * ((c.width - pad*2) / Math.max(n-1,1));
      const Y = (s) => c.height - 30 - (s / Math.max(maxStreak,1)) * (c.height - 60);

      // 最大連勝を先に計算
      seq.forEach(v => { streak = v ? streak+1 : 0; maxStreak = Math.max(maxStreak, streak); });

      // 再描画
      streak = 0;
      ctx.strokeStyle = '#0ea5e9'; ctx.lineWidth = 2; ctx.beginPath();
      for (let i=0;i<seq.length;i++){
        streak = seq[i] ? streak+1 : 0;
        const x = X(i, seq.length), y = Y(streak);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();

      const ic = document.getElementById('pcInd')?.getContext('2d');
      if (ic){
        const c2 = document.getElementById('pcInd');
        ic.clearRect(0,0,c2.width,c2.height);
        const N = Math.min(seq.length, 20);
        const start = seq.length - N;
        for (let i=0;i<N;i++){
          const v = seq[start+i];
          const x = 20 + i * ((c2.width-40)/Math.max(N-1,1));
          const y = c2.height/2;
          ic.fillStyle = v ? '#60a5fa' : '#ef4444';
          ic.beginPath(); ic.arc(x,y,6,0,Math.PI*2); ic.fill();
        }
      }
    }
  }

  function renderCharts(){
    const arr = loadArr();
    drawSpark(arr);
    drawPc(arr);
  }

  // 回答ボタンにフック（既存ロジックに加えて実行）
  const hook = (id, r) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('click', () => { pushResult(r); renderCharts(); }, { passive:true });
  };
  hook('btnAgain', 0);
  hook('btnHard',  1);
  hook('btnGood',  2);

  // 問題が切り替わったら自動再描画（promptの変化を監視）
  const promptEl = document.getElementById('prompt');
  if (promptEl){
    const mo = new MutationObserver(() => renderCharts());
    mo.observe(promptEl, { childList:true, subtree:true, characterData:true });
  }

  // 初期描画
  window.addEventListener('load', renderCharts);
})();
</script>
  
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>

</body>
</html>
